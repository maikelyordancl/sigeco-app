# Nombre del flujo de trabajo
name: Deploy to Server

# Se activa con cada push a la rama 'main'
on:
  push:
    branches:
      - main

jobs:
  deploy:
    # MÃ¡quina virtual donde se ejecuta el trabajo
    runs-on: ubuntu-latest
    
    # Especifica el entorno de despliegue para usar sus secrets
    environment: sigeco

    steps:
      # AcciÃ³n que se conecta por SSH y ejecuta los comandos
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Moverse a la carpeta del proyecto
            cd /home/sigeco
            
            # 2. Descargar los Ãºltimos cambios del repositorio
            echo "ğŸšš Descargando cambios..."
            git pull origin main
            
            # 3. Reconstruir las imÃ¡genes de Docker
            echo "ğŸ› ï¸ Reconstruyendo imÃ¡genes..."
            docker-compose build
            
            # 4. Reiniciar los servicios con los nuevos cambios
            echo "ğŸš€ Reiniciando contenedores..."
            docker-compose up -d --force-recreate
            
            # 5. (Opcional) Limpiar imÃ¡genes viejas para ahorrar espacio
            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
            docker system prune -af --volumes || true
            
            echo "âœ… Â¡Despliegue finalizado!"